name: deploy-homeserver

on:
  push:
    branches:
      - main
      - master
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: Force rebuild and migration even when no app code changed
        required: false
        type: boolean
        default: false

permissions:
  contents: read

concurrency:
  group: deploy-homeserver-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed paths
        if: github.event_name == 'push'
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            frontend:
              - 'resources/**'
              - 'public/**'
              - 'package.json'
              - 'package-lock.json'
              - 'vite.config.ts'
              - 'tsconfig.json'
              - 'eslint.config.js'
            backend:
              - 'app/**'
              - 'bootstrap/**'
              - 'config/**'
              - 'database/**'
              - 'routes/**'
              - 'artisan'
              - 'composer.json'
              - 'composer.lock'
            infra:
              - 'docker/**'
              - 'docker-compose.yml'
              - 'scripts/deploy-homeserver.sh'
              - '.env.example'

      - name: Resolve deployment flags
        id: flags
        env:
          EVENT_NAME: ${{ github.event_name }}
          FRONTEND_FILTER: ${{ steps.changes.outputs.frontend }}
          BACKEND_FILTER: ${{ steps.changes.outputs.backend }}
          INFRA_FILTER: ${{ steps.changes.outputs.infra }}
          FORCE_REBUILD_INPUT: ${{ github.event.inputs.force_rebuild || 'false' }}
        run: |
          frontend="false"
          backend="false"
          infra="false"

          if [[ "${EVENT_NAME}" == "push" ]]; then
            frontend="${FRONTEND_FILTER}"
            backend="${BACKEND_FILTER}"
            infra="${INFRA_FILTER}"
          else
            # Manual runs default to full deploy.
            frontend="true"
            backend="true"
          fi

          if [[ "${infra}" == "true" ]]; then
            frontend="true"
            backend="true"
          fi

          force="${FORCE_REBUILD_INPUT}"
          deploy="false"

          if [[ "${frontend}" == "true" || "${backend}" == "true" || "${force}" == "true" ]]; then
            deploy="true"
          fi

          echo "frontend_changed=${frontend}" >> "${GITHUB_OUTPUT}"
          echo "backend_changed=${backend}" >> "${GITHUB_OUTPUT}"
          echo "force_rebuild=${force}" >> "${GITHUB_OUTPUT}"
          echo "deploy=${deploy}" >> "${GITHUB_OUTPUT}"

      - name: Skip deploy
        if: steps.flags.outputs.deploy != 'true'
        run: echo "No frontend/backend/infra changes detected. Skipping deployment."

      - name: Connect to Tailscale
        if: steps.flags.outputs.deploy == 'true'
        uses: tailscale/github-action@v3
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}

      - name: Configure SSH
        if: steps.flags.outputs.deploy == 'true'
        env:
          HOMESERVER_SSH_PRIVATE_KEY: ${{ secrets.HOMESERVER_SSH_PRIVATE_KEY }}
          HOMESERVER_HOST: ${{ secrets.HOMESERVER_HOST }}
        run: |
          install -m 700 -d ~/.ssh
          KEY_MATERIAL="$(printf '%b' "${HOMESERVER_SSH_PRIVATE_KEY}" | tr -d '\r')"

          if [[ "${KEY_MATERIAL}" == *"-----BEGIN "* ]]; then
            printf '%s\n' "${KEY_MATERIAL}" > ~/.ssh/id_deploy
          else
            if ! printf '%s' "${KEY_MATERIAL}" | base64 -d > ~/.ssh/id_deploy; then
              echo "::error::HOMESERVER_SSH_PRIVATE_KEY is invalid. Provide a raw private key (preferred) or base64-encoded private key."
              exit 1
            fi
          fi

          chmod 600 ~/.ssh/id_deploy

          if ! ssh-keygen -y -f ~/.ssh/id_deploy >/dev/null 2>&1; then
            echo "::error::SSH private key could not be parsed. Ensure it is a PRIVATE key (not .pub) and not passphrase-protected."
            exit 1
          fi

          ssh-keyscan -H "${HOMESERVER_HOST}" >> ~/.ssh/known_hosts

      - name: Deploy to homeserver
        if: steps.flags.outputs.deploy == 'true'
        env:
          HOMESERVER_HOST: ${{ secrets.HOMESERVER_HOST }}
          HOMESERVER_USER: ${{ secrets.HOMESERVER_USER }}
          HOMESERVER_APP_DIR: ${{ secrets.HOMESERVER_APP_DIR }}
          DEPLOY_BRANCH: ${{ github.ref_name }}
          FRONTEND_CHANGED: ${{ steps.flags.outputs.frontend_changed }}
          BACKEND_CHANGED: ${{ steps.flags.outputs.backend_changed }}
          FORCE_REBUILD: ${{ steps.flags.outputs.force_rebuild }}
        run: |
          ssh -i ~/.ssh/id_deploy -o IdentitiesOnly=yes "${HOMESERVER_USER}@${HOMESERVER_HOST}" \
            "APP_DIR='${HOMESERVER_APP_DIR}' DEPLOY_BRANCH='${DEPLOY_BRANCH}' FRONTEND_CHANGED='${FRONTEND_CHANGED}' BACKEND_CHANGED='${BACKEND_CHANGED}' FORCE_REBUILD='${FORCE_REBUILD}' bash '${HOMESERVER_APP_DIR}/scripts/deploy-homeserver.sh'"
