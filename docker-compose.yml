services:
  app:
    image: "${COMPOSE_PROJECT_NAME:-rengiat}-app:latest"
    build:
      context: .
      dockerfile: docker/php/Dockerfile
      target: app-runtime
      network: host
      args:
        HOST_UID: ${HOST_UID:-1000}
        HOST_GID: ${HOST_GID:-1000}
    working_dir: /var/www/html
    env_file:
      - .env
    environment:
      DB_CONNECTION: sqlite
      DB_DATABASE: /var/www/html/storage/app/database.sqlite
    command: >
      sh -c "
        set -e;
        mkdir -p storage/app/public storage/framework/cache storage/framework/sessions storage/framework/views storage/logs bootstrap/cache;
        touch storage/app/database.sqlite;
        chown -R www-data:www-data storage bootstrap/cache;
        if [ ! -L public/storage ]; then php artisan storage:link; fi;
        php-fpm
      "
    volumes:
      - storage:/var/www/html/storage
    restart: unless-stopped

  web:
    image: "${COMPOSE_PROJECT_NAME:-rengiat}-web:latest"
    build:
      context: .
      dockerfile: docker/php/Dockerfile
      target: web-runtime
      network: host
    ports:
      - "${WEB_PORT:-8086}:80"
    depends_on:
      - app
    volumes:
      - storage:/var/www/html/storage:ro
    restart: unless-stopped

volumes:
  storage:
